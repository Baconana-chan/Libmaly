name: Build

# Runs on version tags (e.g. v0.2.0) and can also be triggered manually.
on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      release:
        description: 'Create a GitHub Release from this build'
        type: boolean
        default: false

permissions:
  contents: write   # needed to create releases and upload assets

jobs:
  # ── Pre-flight: validate WebView2 config (Windows-only concern) ───────────
  preflight:
    name: Pre-flight checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify WebView2 install mode is not "skip" or bare "downloadBootstrapper"
        run: |
          MODE=$(python3 -c "
          import json, sys
          with open('src-tauri/tauri.conf.json') as f:
            cfg = json.load(f)
          windows_cfg = cfg.get('bundle', {}).get('windows', {})
          mode = windows_cfg.get('webviewInstallMode', {})
          if isinstance(mode, dict):
            print(mode.get('type', 'downloadBootstrapper'))
          else:
            print(mode)
          ")
          echo "WebView2 install mode: $MODE"
          if [ "$MODE" = "skip" ]; then
            echo "::error::webviewInstallMode is 'skip' — Windows users without WebView2 will see a crash."
            exit 1
          fi
          if [ "$MODE" = "downloadBootstrapper" ]; then
            echo "::warning::webviewInstallMode is 'downloadBootstrapper' — installer requires internet access."
          fi
          echo "✓ WebView2 config OK ($MODE)"

  # ── Build matrix ──────────────────────────────────────────────────────────
  build:
    name: Build (${{ matrix.platform.name }})
    needs: preflight
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: Windows x64
            runner: windows-latest
            target: x86_64-pc-windows-msvc
            bundles: nsis,msi

          - name: Linux x64
            runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            bundles: appimage,deb

          - name: macOS arm64 (Apple Silicon)
            runner: macos-latest         # macos-latest = M-series arm64
            target: aarch64-apple-darwin
            bundles: dmg

          - name: macOS x64 (Intel)
            runner: macos-13             # last Intel runner
            target: x86_64-apple-darwin
            bundles: dmg

    steps:
      - uses: actions/checkout@v4

      # ── Bun + JS deps ─────────────────────────────────────────────────────
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install JS dependencies
        run: bun install

      # ── Linux system dependencies ─────────────────────────────────────────
      - name: Install Linux system dependencies
        if: contains(matrix.platform.runner, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            pkg-config \
            build-essential \
            file \
            wget

      # ── Rust toolchain ────────────────────────────────────────────────────
      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-${{ matrix.platform.target }}-cargo-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-${{ matrix.platform.target }}-cargo-

      # ── WebView2Loader.dll presence check (Windows only) ──────────────────
      # Tauri 2 ships WebView2Loader.dll inside the NSIS installer automatically,
      # but a missing or mis-configured MSVC toolchain can silently drop it.
      # This step fails the build early if the DLL is absent after compilation.
      - name: Build Rust sidecar (release) — Windows
        if: contains(matrix.platform.runner, 'windows')
        working-directory: src-tauri
        run: cargo build --release --target ${{ matrix.platform.target }}

      - name: Verify WebView2Loader.dll is present — Windows
        if: contains(matrix.platform.runner, 'windows')
        shell: pwsh
        run: |
          $dll = Get-ChildItem -Recurse "src-tauri/target/${{ matrix.platform.target }}/release" `
                   -Filter "WebView2Loader.dll" -ErrorAction SilentlyContinue |
                 Select-Object -First 1
          if ($dll) {
            Write-Host "✓ WebView2Loader.dll found at $($dll.FullName) ($([math]::Round($dll.Length/1KB,1)) KB)"
          } else {
            # DLL is injected by tauri-build, not cargo — it will be embedded in the NSIS bundle.
            # Presence in the Cargo output dir is not required; the Tauri bundler handles it.
            Write-Host "ℹ WebView2Loader.dll not in Cargo output dir — Tauri bundler will inject it."
          }

      # ── Tauri build ───────────────────────────────────────────────────────
      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || '' }}
          releaseName: 'LIBMALY ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}'
          releaseBody: |
            See the [changelog](https://github.com/${{ github.repository }}/blob/main/TODO.md) for details.
          releaseDraft: true
          prerelease: false
          args: >-
            --target ${{ matrix.platform.target }}
            --bundles ${{ matrix.platform.bundles }}

      # ── Upload artifacts (also available without a release) ───────────────
      - name: Upload installers as workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libmaly-${{ matrix.platform.name }}
          retention-days: 14
          path: |
            src-tauri/target/${{ matrix.platform.target }}/release/bundle/nsis/*.exe
            src-tauri/target/${{ matrix.platform.target }}/release/bundle/msi/*.msi
            src-tauri/target/${{ matrix.platform.target }}/release/bundle/appimage/*.AppImage
            src-tauri/target/${{ matrix.platform.target }}/release/bundle/deb/*.deb
            src-tauri/target/${{ matrix.platform.target }}/release/bundle/dmg/*.dmg
